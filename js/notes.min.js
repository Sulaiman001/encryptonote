var favicon=new Favico({bgColor:"#da8851",animation:"popFade"}),badgeCount=0;function enc(a){return encodeURIComponent(a)}function addSecret(){return"&s="+enc(getSecret())}function loadTemplate(a){a=$("#"+a).html();a=Handlebars.compile(a);$("#content").html(a)}prevtime=parseInt((new Date).getTime());threshold=500;curval="";t=null;
function applyEditorEvents(){$(".save").on("click",function(){saveNote(CKEDITOR.instances.editor.getData())});var a=$(".scroller-save").offset();$(window).scroll(function(){var b=$(window).scrollTop();a.top<b?$(".scroller-save").addClass("scroller"):$(".scroller-save").removeClass("scroller")});CKEDITOR.instances.editor.document.on("keyup",function(a){curtime=parseInt((new Date).getTime());next=prevtime+threshold;prevtime=curtime;curtime<next&&(clearTimeout(t),t=setTimeout(function(){badgeCount+=
1;favicon.badge(badgeCount);$(".save").hasClass("success")&&$(".save").removeClass("success").addClass("warning")},threshold))})}
function loadNote(a,b){$.getJSON("services.php?a=load-note&n="+a+addSecret(),function(a){a.hasOwnProperty("status")?$(".message").html(a.message).addClass("callout").addClass("warning"):(loadTemplate("notes-editor"),CKEDITOR.replace("editor"),$("#editor").val(a.text),console.log("json.modified.date: "+a.modified.date),$(".last-saved").html(new Date(a.modified.date)),CKEDITOR.instances.editor.on("instanceReady",function(){b()}))})}
function saveNote(a){$.ajax({type:"POST",url:"services.php",data:"a=save-note&n="+enc(getNoteId())+"&text="+enc(a)+addSecret(),dataType:"json",success:function(a){"ok"===a.status?(resetBadge(),$(".last-saved").fadeOut("fast"),$(".save").fadeOut("fast"),$(".last-saved").html(new Date),$(".last-saved").fadeIn("slow"),$(".save").fadeIn("slow"),$(".save").hasClass("warning")&&$(".save").removeClass("warning").addClass("success")):$(".message").html(a.message).addClass("callout").addClass("warning")}})}
function resetBadge(){badgeCount=0;favicon.reset()}var init=function(){resetBadge();switch(getAction()){case "note":var a=getNoteId(),b=void 0!==getSecret()?getSecret():"";if(void 0===a||null===a)window.location="#/note/home/"+b;loadNote(getNoteId(),applyEditorEvents);break;default:window.location.hash="#/note/home/"}};function getHashVars(){var a=window.location.hash,a=a.replace(/^#/,"");return a.split("/")}function getAction(){return getHashVars()[1]}
function getNoteId(){return getHashVars()[2]}function getSecret(){return getHashVars()[3]}$(document).ready(function(){init();$(window).on("hashchange",function(){init()});FastClick.attach(document.body);loadNote(getNoteId(),applyEditorEvents);$(document).bind("keydown","ctrl+s",function(){saveNote(CKEDITOR.instances.editor.getData())})});
